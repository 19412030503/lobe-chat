# 额度管理功能测试指南

## 问题修复说明

### 修复的问题

1. ✅ **Root 账号看不到组织额度列表** - 已修复
   - 原因：数据库中的组织没有对应的 `model_credits` 记录
   - 解决：修改 `listAllOrganizationCredits` API，自动为所有组织创建初始额度记录（余额为 0）

2. ✅ **成员额度列表为空** - 已修复
   - 原因：用户加入组织后，没有自动创建 `member_quotas` 记录
   - 解决：修改 `listMemberQuotas` API，查询组织所有用户，为每个用户自动创建初始额度记录（无限额）

3. ✅ **Admin 用户需要手动选择组织** - 已优化
   - 解决：Admin 用户登录后自动选择其所属组织，不需要手动选择
   - Root 用户保留组织选择下拉框

4. ✅ **添加了空状态提示**
   - 当没有组织时，显示：「暂无组织，请先在「组织管理」中创建组织」
   - 当组织没有成员时，显示：「该组织暂无成员，请先在「用户管理」中添加成员到此组织」

## 测试前准备

### 1. 确保数据库中有测试数据

```sql
-- 检查是否有组织
SELECT * FROM organizations;

-- 如果没有组织，需要先创建
-- 通过管理界面：管理 -> 组织管理 -> 新建组织
```

## 测试步骤

### 场景 1：Root 用户 - 组织额度管理

#### 测试步骤：

1. 使用 **root** 账号登录
2. 进入：**管理 -> 额度管理**
3. 查看「组织额度总览」表格

#### 预期结果：

- ✅ 应该能看到所有组织的列表
- ✅ 每个组织显示：
  - 组织名称
  - 组织类型（管理层 / 学校）
  - 额度余额（初始为 0）
  - 更新时间
  - 操作按钮：「设置额度」、「查看成员」

#### 测试设置额度：

1. 点击某个组织的「设置额度」按钮
2. 在弹窗中输入额度数值（如：10000）
3. 点击「确定」

#### 预期结果：

- ✅ 提示「组织额度更新成功」
- ✅ 表格中该组织的额度余额更新为新值

---

### 场景 2：Root 用户 - 成员额度管理

#### 测试步骤：

1. 在额度管理页面
2. 在「成员额度管理」卡片中，从下拉框选择一个组织
3. 查看该组织的成员列表

#### 预期结果：

- ✅ 显示该组织所有成员
- ✅ 每个成员显示：
  - 姓名
  - 邮箱
  - 个人限额（默认为「无限额」）
  - 已使用额度
  - 使用百分比
  - 操作按钮：「设置额度」

#### 测试设置成员额度：

1. 点击某个成员的「设置额度」按钮
2. 输入限额数值（如：1000）或留空表示无限额
3. 点击「确定」

#### 预期结果：

- ✅ 提示「成员额度更新成功」
- ✅ 表格中该成员的限额更新

---

### 场景 3：Admin 用户 - 成员额度管理

#### 测试步骤：

1. 使用 **admin** 账号登录（需要属于某个组织）
2. 进入：**管理 -> 额度管理**
3. 只能看到「成员额度管理」部分（不显示组织额度总览）
4. 下拉框只显示本组织

#### 预期结果：

- ✅ 不显示「组织额度总览」（仅 Root 可见）
- ✅ 只能查看和管理本组织的成员额度
- ✅ 可以为本组织成员设置个人限额

---

### 场景 4：普通用户 - 查看额度信息

#### 测试步骤：

1. 使用 **普通用户** 账号登录
2. 进入：**设置 -> 账户 -> 使用记录** 或 **个人中心 -> 使用记录**

#### 预期结果：

- ✅ 显示两个并排的卡片：

  **左侧 - 组织额度卡片：**
  - 组织名称
  - 额度余额（显示组织总额度）

  **右侧 - 我的额度卡片：**
  - 个人限额（如果管理员设置了）
  - 已使用额度
  - 剩余额度
  - 使用进度条（颜色：正常 / 警告 / 危险）

- ✅ 下方显示使用记录表格：
  - 时间
  - 类型（chat/image/3d）
  - 供应商
  - 模型
  - Token 数
  - 消耗额度
  - 支持日期筛选和分页

---

### 场景 5：使用记录查询

#### Root 测试：

1. 进入：**管理 -> 使用记录**
2. 查看所有用户的使用记录
3. 可以按组织筛选
4. 可以按日期范围筛选

#### Admin 测试：

1. 进入：**管理 -> 使用记录**
2. 只能查看本组织用户的使用记录
3. 可以按日期范围筛选

#### 用户测试：

1. 进入：**设置 -> 账户 -> 使用记录**
2. 只能看到自己的使用记录
3. 可以按日期范围筛选

---

## 数据验证

### 检查数据库

```sql
-- 检查组织额度
SELECT o.name, mc.balance, mc.updated_at
FROM organizations o
LEFT JOIN model_credits mc ON o.id = mc.organization_id;

-- 检查成员额度
SELECT u.full_name, u.email, mq.limit, mq.used, o.name as org_name
FROM users u
LEFT JOIN member_quotas mq ON u.id = mq.user_id
LEFT JOIN organizations o ON mq.organization_id = o.id;

-- 检查使用记录
SELECT mu.created_at, u.full_name, mu.usage_type, mu.model, mu.credit_cost
FROM model_usages mu
LEFT JOIN users u ON mu.user_id = u.id
ORDER BY mu.created_at DESC
LIMIT 20;
```

---

## 常见问题排查

### 问题：看不到组织列表

**解决方案：**

1. 确认用户角色是 `root`
2. 检查数据库是否有组织：`SELECT * FROM organizations;`
3. 如果没有组织，先创建：管理 -> 组织管理 -> 新建组织
4. 刷新额度管理页面，系统会自动创建额度记录

### 问题：普通用户看不到额度信息

**解决方案：**

1. 确认用户已加入组织
2. 确认组织有额度记录
3. 检查浏览器控制台是否有错误

### 问题：设置额度失败

**解决方案：**

1. 检查用户权限（Root 设置组织额度，Admin/Root 设置成员额度）
2. 确认输入的数值有效（非负整数）
3. 查看浏览器控制台错误信息

---

## API 端点说明

| 端点                               | 权限       | 说明             |
| ---------------------------------- | ---------- | ---------------- |
| `quota.listAllOrganizationCredits` | Root       | 查询所有组织额度 |
| `quota.listMemberQuotas`           | Admin/Root | 查询组织成员额度 |
| `quota.setMemberQuota`             | Admin/Root | 设置成员限额     |
| `quota.getMyQuota`                 | User       | 查询个人额度     |
| `quota.getMyOrganizationCredit`    | User       | 查询所属组织额度 |
| `quota.listMyUsages`               | User       | 查询个人使用记录 |
| `quota.listAllUsages`              | Root       | 查询所有使用记录 |
| `quota.listOrganizationUsages`     | Admin/Root | 查询组织使用记录 |
| `organization.setCredit`           | Root       | 设置组织额度     |

---

## 测试清单

- [ ] Root 能看到所有组织的额度列表
- [ ] Root 能成功设置组织额度
- [ ] Root 能为任意组织的成员设置限额
- [ ] Admin 只能看到本组织的成员列表
- [ ] Admin 能为本组织成员设置限额
- [ ] Admin 不能看到其他组织
- [ ] 普通用户能看到组织额度信息
- [ ] 普通用户能看到个人额度和使用情况
- [ ] 进度条正确显示使用百分比
- [ ] 当额度不足时显示红色警告
- [ ] 使用记录正确显示并支持筛选
- [ ] 空状态提示正确显示
- [ ] 所有翻译键正确显示中文

---

## 下一步优化建议

1. **批量操作**：支持批量设置多个成员的额度
2. **额度预警**：当组织或用户额度不足时发送通知
3. **额度充值记录**：记录每次额度调整的历史
4. **使用统计图表**：可视化展示额度使用趋势
5. **导出功能**：支持导出使用记录为 Excel
